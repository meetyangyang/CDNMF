Smart grid planning and control is becoming a theme of high interest in the last years. This is due to the presence of distributed generation;  power from renewable resources and storage systems;  to the different actors present over the territory;  and to the difficulty of defining appropriate models for decision support. A bilevel optimal control scheme is proposed for grids characterized by renewable and traditional power production;  bidirectional power flows;  dynamic storage systems;  and stochastic modeling issues. In this scheme;  the upper level decision maker (UDM) views the lower level decision makers (LDMs) or microgrids as single nodes. In the statement of the UDM problem;  the LDM control strategies are structurally and parametrically constrained inside a nonlinear optimization problem that includes load flow equations. Then;  the LDMs can follow references from the UDM and use available information at the local level to solve a stochastic optimization problem. The proposed control architecture has been applied to a specific case study (Savona;  Italy). 