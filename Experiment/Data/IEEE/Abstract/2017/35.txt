To reduce energy costs and emissions of microgrids;  daily operation is critical. The problem is to commit and dispatch distributed devices with renewable generation to minimize the total energy and emission cost while meeting the forecasted energy demand. The problem is challenging because of the intermittent nature of renewables. In this paper;  photovoltaic (PV) uncertainties are modeled by a Markovian process. For effective coordination;  other devices are modeled as Markov processes with states depending on PV states. The entire problem is Markovian. This combinatorial problem is solved using branch-and-cut. Beyond energy and emission costs;  to consider capital and maintenance costs in the long run;  microgrid design is also essential. The problem is to decide device sizes with given types to minimize the lifetime cost while meeting energy demand. Its complexity increases exponentially with the problem size. To evaluate the lifetime cost including the reliability cost and the classic components such as capital and fuel costs;  a linear model is established. By selecting a limited number of possible combinations of device sizes;  exhaustive search is used to find the optimized design. The results show that the operation method is efficient in saving cost and scalable;  and microgrids have lower lifetime costs than conventional energy systems. Implications for regulators and distribution utilities are also discussed. 